+++
date = '2024-12-18'
draft = false
title = 'Gradle: Veröffentlichen ohne BOM'
categories = [ 'Gradle' ]
tags = [ 'gradle', 'java', 'publish' ]
+++

<!--
Gradle: Veröffentlichen ohne BOM
================================
-->

Bei einem meiner Kunden hängen die Java-Projekte
von einem BOM-Projekt ab, welches konkrete Versionen
vorgibt. Dadurch erreichen wir es, dass bspw. Sicherheitsvorgaben
durch Modifikation des BOM-Projektes in allen Java-Projekten
umgesetzt werden. Versionen werden nur im BOM-Projekt vorgegeben
und nicht in den einzelnen Java-Projekten.

Leider veröffentlichen einige der Java-Projekte API-Pakete.
Bislang enthalten diese eine Abhängigkeit zum BOM-Projekt.
Das wollen wir nicht, weil es die Anwendung der API-Projekte
erschwert.

Hier beschreibe ich, wir man die BOM-Abhängigkeit "ausblendet".
In meinem Beispiel habe ich eine Abhängigkeit zu
"org.springframework.boot:spring-boot-dependencies"
und diese möchte ich "ausblenden".

<!--more-->

Ausgangspunkt: Java-Projekt mit der BOM-Abhängigkeit
----------------------------------------------------

Beispiel: [gradle-bom](/gradle-bom).

Das Projekt erzeugt per Standard die POM-Datei gradle-bom-1.0.0.pom:

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <!-- This module was also published with a richer model, Gradle metadata,  -->
  <!-- which should be used instead. Do not delete the following line which  -->
  <!-- is to indicate to Gradle or any Gradle module metadata file consumer  -->
  <!-- that they should prefer consuming it instead. -->
  <!-- do_not_remove: published-with-gradle-metadata -->
  <modelVersion>4.0.0</modelVersion>
  <groupId>cool.heller</groupId>
  <artifactId>gradle-bom</artifactId>
  <version>1.0.0</version>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-dependencies</artifactId>
        <version>[3.0,)</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-validation</artifactId>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
      <scope>runtime</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
      <scope>runtime</scope>
    </dependency>
  </dependencies>
</project>
```

Erweitern von "build.gradle"
----------------------------

```diff
---------------- my-hugo-site/static/gradle-bom/build.gradle -----------------
index 0bfb773..bdc80ac 100644
@@ -5,7 +5,7 @@ plugins {
 
 group = 'cool.heller'
 //version = '1.0-SNAPSHOT'
-version = '1.0.0'
+version = '1.0.1'
 
 dependencies {
   // org.springframework.boot:spring-boot-dependencies:3.+ declared with a Maven incompatible version notation
@@ -40,8 +40,15 @@ publishing {
     publications {
         javaLibrary(MavenPublication) {
           from components.java
-        }
-    }
+            pom.withXml {
+                asNode().dependencyManagement.dependencies.dependency.each { dep ->
+                  if (dep.artifactId[0].text() in ["spring-boot-dependencies", /*"slf4j-log4j12"*/]) {
+                      assert dep.parent().remove(dep)
+                  }
+                }
+            } // pom
+         } // javaLibrary
+    } // publications
     repositories {
       maven {
         name 'local-registry'
```

Die Idee kommt von [StackOverflow - How to exclude dependencies in the POM file generated by the Gradle](https://stackoverflow.com/questions/29147643/how-to-exclude-dependencies-in-the-pom-file-generated-by-the-gradle)!

Die Zeile mit "spring-boot-dependencies" bedarf einiger Erklärungen:

- "dep" steht quasi für eine Dependency und ist vom Typ "groovy.util.Node"
- "dep.artifactId" liefert ein Array aller XML-Elemente '<artifactId>' - wir wissen, dass es nur eines
  gibt und "nehmen" deshalb das erste und das ist wieder vom Typ "groovy.util.Node"
- Die Methode "text()" liefert davon dann den "Inhalt", der wiederum dem Wert der ArtifactId entspricht
- Dieser Wert wird dann mit einer Liste abgeglichen, die entfernt werden soll. Die Liste enthält
  nur ein Element

Korrigierte POM-Datei
---------------------

Damit erhält man die POM-Datei gradle-bom-1.0.1.pom:

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <!-- This module was also published with a richer model, Gradle metadata,  -->
  <!-- which should be used instead. Do not delete the following line which  -->
  <!-- is to indicate to Gradle or any Gradle module metadata file consumer  -->
  <!-- that they should prefer consuming it instead. -->
  <!-- do_not_remove: published-with-gradle-metadata -->
  <modelVersion>4.0.0</modelVersion>
  <groupId>cool.heller</groupId>
  <artifactId>gradle-bom</artifactId>
  <version>1.0.1</version>
  <dependencyManagement>
    <dependencies/>
  </dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-validation</artifactId>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
      <scope>runtime</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
      <scope>runtime</scope>
    </dependency>
  </dependencies>
</project>
```

Test: Funktioniert es?
----------------------

Java-Projekt, welches die beiden Varianten einbindet: [gradle-bom-use](/gradle-bom-use)

Ich teste beide Varianten durch Variation von "build.gradle":

- Variante 0: `implementation 'cool.heller:gradle-bom:1.0.0'`
- Variante 1: `implementation 'cool.heller:gradle-bom:1.0.1'`

Bei beiden Varianten läuft `gradlew` durch.
Hier die "dependencies" für beide Varianten:

- Variante 0: [dependencies-1.0.0.txt](/gradle-bom-use/dependencies-1.0.0.txt)
- Variante 0: [dependencies-1.0.1.txt](/gradle-bom-use/dependencies-1.0.1.txt)

Sehen beide super aus!

Versionen
---------

Getestet mit

- Gradle-8.11.1

Links
-----

- [StackOverflow - How to exclude dependencies in the POM file generated by the Gradle](https://stackoverflow.com/questions/29147643/how-to-exclude-dependencies-in-the-pom-file-generated-by-the-gradle)

Historie
--------

- 2024-12-18: Erste Version
